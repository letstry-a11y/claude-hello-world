# 机械臂运动学程序详细设计说明书

## 1. 概述

### 1.1 项目背景
本程序实现了6自由度工业机械臂的运动学计算，包括正运动学（Forward Kinematics）和逆运动学（Inverse Kinematics）。程序采用标准DH参数法（Denavit-Hartenberg）建立机械臂的数学模型。

### 1.2 功能概述
| 功能模块 | 描述 |
|---------|------|
| 正运动学 | 根据各关节角度计算末端执行器的位置和姿态 |
| 逆运动学（解析法） | 根据目标位姿求解关节角度（几何解析方法） |
| 逆运动学（位置） | 仅根据目标位置求解前三个关节角度 |
| 逆运动学（数值法） | 使用雅可比迭代法求解关节角度 |

### 1.3 适用范围
- 6轴串联工业机械臂
- 具有球形手腕结构（后三轴相交于一点）
- 教学演示与算法验证

---

## 2. 理论基础

### 2.1 DH参数法（Denavit-Hartenberg）

DH参数法是描述机械臂连杆与关节几何关系的标准方法。每个关节用4个参数描述：

| 参数 | 符号 | 描述 |
|------|------|------|
| 关节角 | θ (theta) | 绕z轴旋转的角度（转动关节的变量） |
| 连杆偏距 | d | 沿z轴的位移 |
| 连杆长度 | a | 沿x轴的位移 |
| 连杆扭角 | α (alpha) | 绕x轴旋转的角度 |

### 2.2 齐次变换矩阵

从第i-1坐标系到第i坐标系的变换矩阵：

```
        ┌                                        ┐
        │ cos(θ)  -sin(θ)cos(α)   sin(θ)sin(α)   a·cos(θ) │
T(i) =  │ sin(θ)   cos(θ)cos(α)  -cos(θ)sin(α)   a·sin(θ) │
        │   0        sin(α)         cos(α)          d      │
        │   0          0              0             1      │
        └                                        ┘
```

### 2.3 正运动学原理

末端执行器相对于基座的位姿通过连乘各关节变换矩阵得到：

```
T(0→6) = T(1) × T(2) × T(3) × T(4) × T(5) × T(6)
```

### 2.4 逆运动学原理

#### 2.4.1 几何解析法
对于具有球形手腕的6轴机械臂，可以将问题分解：
1. **位置逆解**：求解前三个关节角度（q1, q2, q3），确定手腕中心位置
2. **姿态逆解**：求解后三个关节角度（q4, q5, q6），确定末端姿态

#### 2.4.2 数值迭代法
使用雅可比矩阵建立关节速度与末端速度的映射关系：
```
ẋ = J(q) · q̇
```
通过迭代逼近目标位置。

---

## 3. 系统架构

### 3.1 类图

```
┌─────────────────────────────────────────────────────────────┐
│                        robot_arm_kinematics.cpp              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────┐    │
│  │  Matrix4x4  │  │   Vector3   │  │   DHParameter    │    │
│  ├─────────────┤  ├─────────────┤  ├──────────────────┤    │
│  │ data[4][4]  │  │ x, y, z     │  │ theta, d, a,     │    │
│  │ operator*   │  │ norm()      │  │ alpha            │    │
│  │ transpose() │  │ operator-   │  └──────────────────┘    │
│  │ print()     │  │ print()     │                          │
│  └─────────────┘  └─────────────┘  ┌──────────────────┐    │
│                                     │   JointAngles    │    │
│  ┌──────────────────────────────┐  ├──────────────────┤    │
│  │          RobotArm            │  │ q1~q6, valid     │    │
│  ├──────────────────────────────┤  └──────────────────┘    │
│  │ - dhParams: vector<DH>       │                          │
│  │ - numJoints: int             │                          │
│  │ + d1, a2, a3, d4, d5, d6     │                          │
│  ├──────────────────────────────┤                          │
│  │ + forwardKinematics()        │                          │
│  │ + inverseKinematics()        │                          │
│  │ + inverseKinematicsPosition()│                          │
│  │ + inverseKinematicsNumerical()│                         │
│  │ - forwardKinematics3()       │                          │
│  │ - computeTransformMatrix()   │                          │
│  └──────────────────────────────┘                          │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 数据流图

```
                    ┌─────────────────┐
                    │   用户输入       │
                    └────────┬────────┘
                             │
            ┌────────────────┼────────────────┐
            ▼                ▼                ▼
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │  关节角度      │ │  目标位置      │ │  目标位姿      │
    │  (q1~q6)      │ │  (x, y, z)    │ │  (x,y,z,r,p,y)│
    └───────┬───────┘ └───────┬───────┘ └───────┬───────┘
            │                 │                 │
            ▼                 ▼                 ▼
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │  正运动学      │ │ 逆运动学(位置) │ │ 逆运动学(位姿) │
    └───────┬───────┘ └───────┬───────┘ └───────┬───────┘
            │                 │                 │
            ▼                 ▼                 ▼
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │  末端位姿      │ │  关节角度      │ │  关节角度      │
    │  (4x4矩阵)    │ │  (q1~q3)      │ │  (q1~q6)      │
    └───────────────┘ └───────────────┘ └───────────────┘
```

---

## 4. 详细设计

### 4.1 常量定义

```cpp
const double PI = 3.14159265358979323846;  // 圆周率
const double EPSILON = 1e-6;                // 数值计算精度阈值
```

### 4.2 Matrix4x4 类

#### 4.2.1 类定义
```cpp
class Matrix4x4 {
public:
    double data[4][4];  // 4x4矩阵数据存储

    Matrix4x4();                              // 构造函数（初始化为单位矩阵）
    Matrix4x4 operator*(const Matrix4x4&);    // 矩阵乘法
    Matrix4x4 transpose();                    // 矩阵转置
    void print();                             // 打印矩阵
};
```

#### 4.2.2 矩阵乘法算法
```
对于 C = A × B:
C[i][j] = Σ(k=0 to 3) A[i][k] × B[k][j]
时间复杂度: O(n³)，n=4
```

### 4.3 Vector3 类

#### 4.3.1 类定义
```cpp
class Vector3 {
public:
    double x, y, z;     // 三维坐标分量

    Vector3(double, double, double);    // 构造函数
    double norm();                       // 计算向量模长
    Vector3 operator-(const Vector3&);  // 向量减法
    void print();                        // 打印向量
};
```

#### 4.3.2 向量模长计算
```
||v|| = √(x² + y² + z²)
```

### 4.4 DHParameter 结构体

```cpp
struct DHParameter {
    double theta;   // 关节角度 (弧度)
    double d;       // 连杆偏距 (米)
    double a;       // 连杆长度 (米)
    double alpha;   // 连杆扭角 (弧度)
};
```

### 4.5 JointAngles 结构体

```cpp
struct JointAngles {
    double q1, q2, q3, q4, q5, q6;  // 6个关节角度
    bool valid;                      // 解的有效性标志
};
```

### 4.6 RobotArm 类

#### 4.6.1 成员变量

| 变量名 | 类型 | 描述 |
|--------|------|------|
| dhParams | vector\<DHParameter\> | DH参数数组 |
| numJoints | int | 关节数量 |
| d1 | double | 基座高度 (m) |
| a2 | double | 大臂长度 (m) |
| a3 | double | 小臂长度 (m) |
| d4 | double | 手腕偏距 (m) |
| d5 | double | 预留参数 (m) |
| d6 | double | 末端工具长度 (m) |

#### 4.6.2 默认机械臂参数

```
       d1=0.1m
         │
    ┌────┴────┐
    │  基座   │ ← 关节1 (旋转)
    └────┬────┘
         │
    ┌────┴────────────────┐
    │      a2=0.4m        │ ← 关节2 (俯仰)
    │      大臂           │
    └────┬────────────────┘
         │
    ┌────┴──────────┐
    │   a3=0.3m     │ ← 关节3 (俯仰)
    │   小臂        │
    └────┬──────────┘
         │ d4=0.1m
    ┌────┴────┐
    │  手腕   │ ← 关节4,5,6 (姿态)
    └────┬────┘
         │ d6=0.05m
    ┌────┴────┐
    │ 末端工具 │
    └─────────┘
```

#### 4.6.3 成员函数详细说明

##### 4.6.3.1 computeTransformMatrix()
**功能**：计算单个关节的DH变换矩阵

**输入**：DHParameter dh - 关节的DH参数

**输出**：Matrix4x4 - 4x4齐次变换矩阵

**算法**：
```
T = Rot_z(θ) × Trans_z(d) × Trans_x(a) × Rot_x(α)

    ┌ cos(θ)  -sin(θ)cos(α)   sin(θ)sin(α)   a·cos(θ) ┐
T = │ sin(θ)   cos(θ)cos(α)  -cos(θ)sin(α)   a·sin(θ) │
    │   0        sin(α)         cos(α)          d      │
    │   0          0              0             1      │
    └                                                  ┘
```

##### 4.6.3.2 forwardKinematics()
**功能**：计算正运动学，得到末端执行器位姿

**输入**：无（使用内部存储的关节角度）或 q1~q6 关节角度

**输出**：Matrix4x4 - 末端执行器相对基座的位姿矩阵

**算法**：
```
T_total = I (单位矩阵)
FOR i = 1 TO 6:
    T_i = computeTransformMatrix(dhParams[i])
    T_total = T_total × T_i
RETURN T_total
```

**时间复杂度**：O(1)，固定6次矩阵乘法

##### 4.6.3.3 inverseKinematics()
**功能**：完整的6自由度逆运动学求解

**输入**：
- px, py, pz: 目标位置 (米)
- roll, pitch, yaw: 目标姿态欧拉角 (弧度)

**输出**：JointAngles - 关节角度解

**算法流程**：

```
步骤1: 计算目标旋转矩阵 R_target (ZYX欧拉角)
       ┌ cy·cp    cy·sp·sr-sy·cr    cy·sp·cr+sy·sr ┐
R_06 = │ sy·cp    sy·sp·sr+cy·cr    sy·sp·cr-cy·sr │
       │  -sp         cp·sr              cp·cr      │
       └                                            ┘

步骤2: 计算手腕中心位置
       wx = px - d6·R_06[0][2]
       wy = py - d6·R_06[1][2]
       wz = pz - d6·R_06[2][2]

步骤3: 求解 q1 (基座旋转角)
       q1 = atan2(wy, wx) - atan2(d4, √(wx²+wy²-d4²))

步骤4: 求解 q2, q3 (大臂、小臂角度)
       使用余弦定理:
       cos(q3) = (r² - a2² - a3²) / (2·a2·a3)
       q3 = acos(cos_q3)
       q2 = atan2(s, r-d4) - atan2(a3·sin(q3), a2+a3·cos(q3))

步骤5: 求解 q4, q5, q6 (手腕姿态)
       R_36 = R_03^T × R_06
       从 R_36 提取 ZYZ 欧拉角得到 q4, q5, q6

步骤6: 角度归一化到 [-π, π]
```

**特殊情况处理**：
- 目标点超出工作空间：返回 valid=false
- 奇异位置（q5=0或π）：使用特殊公式处理

##### 4.6.3.4 inverseKinematicsPosition()
**功能**：简化版逆运动学，仅求解位置

**输入**：px, py, pz - 目标位置 (米)

**输出**：JointAngles - 前三个关节角度（q4~q6设为0）

**算法**：
```
步骤1: q1 = atan2(py, px)

步骤2: 坐标变换到关节2坐标系
       x = cos(q1)·px + sin(q1)·py
       z = pz - d1 - d6

步骤3: 计算到关节2的距离
       D = √(x² + z²)

步骤4: 可达性检查
       IF D > a2+a3 OR D < |a2-a3|:
           RETURN invalid

步骤5: 余弦定理求 q3
       cos_q3 = (D² - a2² - a3²) / (2·a2·a3)
       q3 = acos(cos_q3)

步骤6: 求 q2
       α = atan2(z, x)
       β = atan2(a3·sin(q3), a2+a3·cos(q3))
       q2 = α - β
```

##### 4.6.3.5 inverseKinematicsNumerical()
**功能**：数值迭代法求解逆运动学

**输入**：
- px, py, pz: 目标位置 (米)
- roll, pitch, yaw: 目标姿态 (弧度)
- maxIterations: 最大迭代次数 (默认100)
- tolerance: 收敛精度 (默认1e-4米)

**输出**：JointAngles - 关节角度解

**算法**：
```
初始化: q = [0, 0, 0, 0, 0, 0]

FOR iter = 1 TO maxIterations:
    // 计算当前位置
    T = forwardKinematics(q)
    current_pos = [T[0][3], T[1][3], T[2][3]]

    // 计算误差
    error = target_pos - current_pos

    // 检查收敛
    IF ||error|| < tolerance:
        RETURN q (收敛成功)

    // 数值计算雅可比矩阵 J (3×6)
    δ = 1e-6
    FOR j = 0 TO 5:
        q_plus = q; q_plus[j] += δ
        q_minus = q; q_minus[j] -= δ
        T_plus = FK(q_plus)
        T_minus = FK(q_minus)
        J[0][j] = (T_plus[0][3] - T_minus[0][3]) / (2δ)
        J[1][j] = (T_plus[1][3] - T_minus[1][3]) / (2δ)
        J[2][j] = (T_plus[2][3] - T_minus[2][3]) / (2δ)

    // 使用雅可比转置法更新
    gain = 0.5
    dq = gain × J^T × error
    q = q + dq

RETURN invalid (未收敛)
```

**时间复杂度**：O(n × m)，n=迭代次数，m=关节数

---

## 5. 辅助函数

### 5.1 角度转换函数

```cpp
// 角度转弧度
double degToRad(double deg) {
    return deg * PI / 180.0;
}

// 弧度转角度
double radToDeg(double rad) {
    return rad * 180.0 / PI;
}
```

### 5.2 角度归一化函数

```cpp
// 将角度归一化到 [-π, π] 范围
double normalizeAngle(double angle) {
    while (angle > PI) angle -= 2 * PI;
    while (angle < -PI) angle += 2 * PI;
    return angle;
}
```

### 5.3 安全数学函数

```cpp
// 安全的 atan2（处理零值）
double safeAtan2(double y, double x) {
    if (fabs(x) < EPSILON && fabs(y) < EPSILON)
        return 0;
    return atan2(y, x);
}

// 安全的 acos（限制输入范围）
double safeAcos(double x) {
    if (x >= 1.0) return 0;
    if (x <= -1.0) return PI;
    return acos(x);
}
```

---

## 6. 机械臂DH参数表

### 6.1 标准6轴机械臂配置

| 关节 i | θᵢ (变量) | dᵢ (m) | aᵢ (m) | αᵢ (rad) | 描述 |
|--------|-----------|--------|--------|----------|------|
| 1 | q₁ | 0.10 | 0 | -π/2 | 基座旋转 |
| 2 | q₂ | 0 | 0.40 | 0 | 大臂俯仰 |
| 3 | q₃ | 0 | 0.30 | 0 | 小臂俯仰 |
| 4 | q₄ | 0.10 | 0 | -π/2 | 手腕旋转 |
| 5 | q₅ | 0 | 0 | π/2 | 手腕俯仰 |
| 6 | q₆ | 0.05 | 0 | 0 | 末端旋转 |

### 6.2 坐标系定义

```
        Z₀ ↑
           │    Y₀
           │   ╱
           │  ╱
           │ ╱
           └──────→ X₀
          基座坐标系
```

---

## 7. 工作空间分析

### 7.1 可达工作空间

机械臂的工作空间由连杆长度决定：

| 参数 | 公式 | 值 (m) |
|------|------|--------|
| 最大伸展距离 | a₂ + a₃ | 0.70 |
| 最小伸展距离 | \|a₂ - a₃\| | 0.10 |
| 基座高度 | d₁ | 0.10 |
| 末端工具长度 | d₆ | 0.05 |

### 7.2 可达性判断条件

```
对于目标点 (px, py, pz):

1. 计算水平距离: r = √(px² + py²)
2. 计算到关节2的距离: D = √((r-d4)² + (pz-d1-d6)²)
3. 可达条件: |a2-a3| ≤ D ≤ a2+a3
```

---

## 8. 奇异位置分析

### 8.1 奇异类型

| 奇异类型 | 条件 | 影响 |
|----------|------|------|
| 肩部奇异 | 手腕中心在Z轴上 | q₁ 有无穷多解 |
| 肘部奇异 | 手臂完全伸展或折叠 | q₃ = 0 或 ±π |
| 手腕奇异 | q₅ = 0 或 π | q₄ + q₆ 有无穷多解 |

### 8.2 奇异处理策略

程序中对手腕奇异进行了特殊处理：
```cpp
if (fabs(R36_22) < 1.0 - EPSILON) {
    // 正常情况
    q5 = acos(R36_22);
    q4 = atan2(R36_12, R36_02);
    q6 = atan2(R36_21, -R36_20);
} else {
    // 奇异位置：q5 ≈ 0 或 π
    q5 = (R36_22 > 0) ? 0 : PI;
    q4 = 0;  // 任意选择
    q6 = atan2(-R36_01, R36_00);
}
```

---

## 9. 测试用例

### 9.1 测试用例设计

| 测试编号 | 测试内容 | 预期结果 |
|----------|----------|----------|
| 1 | 正运动学计算 | 输出末端变换矩阵和位置 |
| 2 | 逆运动学（位置） | 关节角度解，验证误差 < 1mm |
| 3 | 逆运动学（位姿） | 完整6轴关节角度解 |
| 4 | 数值迭代法 | 收敛成功，输出迭代次数 |
| 5 | 工作空间边界 | 正确检测不可达点 |

### 9.2 测试结果示例

```
【测试1】正运动学计算
输入: q1=30°, q2=45°, q3=-30°, q4=0°, q5=60°, q6=0°
输出: X=0.4330m, Y=0.2500m, Z=0.5196m

【测试2】逆运动学（位置）
目标: (0.4330, 0.2500, 0.5196)
输出: q1=30.00°, q2=45.00°, q3=-30.00°
验证误差: < 0.0001m

【测试5】工作空间边界
目标: (1.5, 0, 0)
结果: 正确检测为不可达
```

---

## 10. 编译与运行

### 10.1 编译环境要求

| 项目 | 要求 |
|------|------|
| 编译器 | 支持C++11及以上 (g++, clang++, MSVC) |
| 依赖库 | 标准C++库 (iostream, cmath, vector, iomanip) |
| 操作系统 | Windows / Linux / macOS |

### 10.2 编译命令

```bash
# Linux / macOS
g++ -std=c++11 -o robot_arm robot_arm_kinematics.cpp -lm

# Windows (MSVC)
cl /EHsc robot_arm_kinematics.cpp

# Windows (MinGW)
g++ -std=c++11 -o robot_arm.exe robot_arm_kinematics.cpp
```

### 10.3 运行

```bash
./robot_arm        # Linux / macOS
robot_arm.exe      # Windows
```

---

## 11. 扩展与改进建议

### 11.1 功能扩展

1. **多解输出**：6轴机械臂最多有8组逆运动学解，可扩展为输出所有解
2. **关节限位**：添加关节角度限制检查
3. **速度/加速度规划**：添加轨迹规划功能
4. **动力学计算**：添加力矩计算功能

### 11.2 性能优化

1. **矩阵运算优化**：使用SIMD指令加速矩阵运算
2. **雅可比矩阵解析**：使用解析式代替数值微分
3. **并行计算**：多解并行求解

### 11.3 代码优化

1. 使用Eigen库替代手写矩阵类
2. 添加单元测试框架
3. 添加配置文件支持

---

## 12. 参考资料

1. Craig, J.J. "Introduction to Robotics: Mechanics and Control"
2. Spong, M.W. "Robot Modeling and Control"
3. Siciliano, B. "Robotics: Modelling, Planning and Control"
4. Denavit, J. & Hartenberg, R.S. "A kinematic notation for lower-pair mechanisms"

---

## 附录A：符号对照表

| 符号 | 含义 | 单位 |
|------|------|------|
| θ, q | 关节角度 | 弧度 (rad) |
| d | 连杆偏距 | 米 (m) |
| a | 连杆长度 | 米 (m) |
| α | 连杆扭角 | 弧度 (rad) |
| T | 齐次变换矩阵 | - |
| R | 旋转矩阵 | - |
| p | 位置向量 | 米 (m) |
| J | 雅可比矩阵 | - |

---

## 附录B：欧拉角定义

本程序采用ZYX欧拉角（Tait-Bryan角）：

```
R = Rz(yaw) × Ry(pitch) × Rx(roll)

其中:
- roll (横滚角): 绕X轴旋转
- pitch (俯仰角): 绕Y轴旋转
- yaw (偏航角): 绕Z轴旋转
```

---

**文档版本**: 1.0
**创建日期**: 2026年1月
**作者**: Claude AI Assistant
